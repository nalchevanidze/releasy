# Relasy

Relasy is a set of GitHub Actions for **label-driven releases**. It automates the full flow:

- determine the **next version** from PR labels
- generate a **changelog** from merged PRs since the last release
- open a **release PR** containing both the changelog and the version bump commit
- publish a **GitHub Release** when that release PR is merged

> **Source of truth:** the **release PR** generated by `draft-release`.

---

## How it works (Draft ‚Üí Release PR ‚Üí Publish)

### 1) Draft release (`draft-release` action)
Triggered manually (usually via `workflow_dispatch`).

`draft-release` will:
- collect merged PRs since the last GitHub Release (or tag)
- compute the **next version** using PR labels (semver bump rules)
- update version files (based on your config), and **commit** the version bump
- generate a changelog grouped by labels (and optionally by package scope)
- open a **release PR** to `main`:
  - **title:** `release-<version>`
  - **body:** generated changelog
  - **commits:** includes the version bump commit generated by the action

‚úÖ You **do not** need to bump versions manually.

### 2) Review the release PR
Before merging, you can optionally edit the PR body to:
- polish wording
- reorder sections
- remove internal notes, etc.
- commit additional changes if needed (manual fixes, etc.)

### 3) Publish release (`publish-release` action)
Triggered when the release PR is merged.

`publish-release` will:
- detect merged PRs where:
  - base branch is `main`
  - head branch starts with `release-`
- use the **merged release PR body** as the release notes
- create/publish the **GitHub Release** (optionally returning an `upload_url` output)

---

## Labels drive versioning & changelogs

Relasy uses PR labels to decide:
- **what bump** a change represents (major/minor/patch)
- **where it appears** in the changelog (Breaking / Features / Fixes / etc.)
- optional **scope** (package/module grouping for monorepos)

Typical mapping:
- `type:breaking` ‚Üí **major**
- `type:feature` ‚Üí **minor**
- `type:fix` ‚Üí **patch**
- `scope:<name>` ‚Üí scope/grouping in changelog for monorepos

When multiple PRs are included in a release, Relasy applies the **highest bump** needed across them (major > minor > patch).

---

## Monorepo support (optional)

If you use scope labels like `scope:client` / `scope:server`, Relasy can:
- group changelog entries by package
- keep the release notes readable even with many PRs

---

## Configuration (`relasy.json`)

Relasy reads configuration from `relasy.json` to adapt to your repo conventions without changing action code.

At a high level, `relasy.json` describes:
- the **scopes** in your repo (single package or many packages/modules)
- optional headings for changelog grouping (`changeTypes`)
- which **manager** is used to resolve versioning/publishing details (`project`)

### Schema overview

```json
{
  "scopes": { "scopeKey": "packageIdentifier" },
  "changeTypes": {
    "major": "Major Change",
    "breaking": "Breaking Change",
    "feature": "New features",
    "fix": "Bug Fixes",
    "chore": "Minor Changes"
  },
  "project": {
    "type": "npm"
  }
}
````

### `scope`

`scope` is a mapping of logical **scope keys** to a **package identifier**.

* For **npm** projects, the value is typically the npm package name (often scoped).
* For **custom** projects, the value is whatever identifier the custom workflow expects.

The `scopes` keys (`core`, `server`, `client`, etc.) are the handles you reference when you need to act on a specific module/package.

### `changeTypes` (optional)

`changeTypes` is an optional mapping from change type ‚Üí human-readable heading used for grouping changes
(e.g. in release notes / changelog sections).

Supported change types:

* `major`
* `breaking`
* `feature`
* `fix`
* `chore`

If `changeTypes` is omitted, Relasy uses these defaults:

* `major`: `Major Change`
* `breaking`: `Breaking Change`
* `feature`: `New features`
* `fix`: `Bug Fixes`
* `chore`: `Minor Changes`

You can override any subset by providing only those keys.

### `project`

`project` selects the manager used by Relasy.

Supported managers:

* `type: "npm"`
* `type: "custom"`

If `type` is `"custom"`, the following fields are required:

* `pkg` (string): a package reference or URL template (can include `{{SCOPE}}`)
* `version` (string): command to retrieve the current version
* `next` (string): command to compute the next version
* `setup` (string): command to prepare tooling/environment

---

## Configuration examples

### npm project (single scope)

```json
{
  "scopes": {
    "core": "relasy/core"
  },
  "project": {
    "type": "npm"
  }
}
```

### custom project (multi-scope)

```json
{
  "scopes": {
    "server": "morpheus-graphql",
    "client": "morpheus-graphql-client",
    "core": "morpheus-graphql-core",
    "subscriptions": "morpheus-graphql-subscriptions",
    "tests": "morpheus-graphql-tests",
    "app": "morpheus-graphql-app",
    "codegen": "morpheus-graphql-code-gen"
  },
  "project": {
    "type": "custom",
    "pkg": "https://hackage.haskell.org/package/{{SCOPE}}",
    "version": "hconf version",
    "next": "hconf next",
    "setup": "hconf setup 9.6.3"
  }
}
```

**Notes:**

* In custom mode, `{{SCOPE}}` is substituted with the resolved scope identifier
  (e.g. `morpheus-graphql-core`).

---

## Publishing strategies

### `npm` (simple, centralized version)

When `project.type` is `"npm"`:

* versioning is typically **centralized** (e.g. one version source of truth)
* best suited when packages share a version

‚úÖ easiest to operate
‚ö†Ô∏è not suitable if each package needs independent versions

### `custom` (fully flexible)

When `project.type` is `"custom"`:

* use it when you need custom versioning rules or publishing commands

‚úÖ best for complex repos / bespoke pipelines

---

## Example: generated changelog (release PR body)

Example output (placeholders only):

```md
## 1.4.0 (2026-01-14)

#### Breaking Changes
* [#123](https://github.com/acme/awesome-monorepo/pull/123): Remove legacy auth middleware
  - üì¶ scope:server
  - üë§ @contributor-1

#### New features
* [#141](https://github.com/acme/awesome-monorepo/pull/141): Add caching for search endpoint
  - üì¶ scope:server
  - üë§ @contributor-2
* [#155](https://github.com/acme/awesome-monorepo/pull/155): Add dark mode toggle
  - üì¶ scope:client
  - üë§ @contributor-3

#### Bug Fixes
* [#160](https://github.com/acme/awesome-monorepo/pull/160): Fix pagination edge case for empty results
  - üì¶ scope:client
  - üë§ @contributor-4

#### Minor Changes
* [#166](https://github.com/acme/awesome-monorepo/pull/166): Update local dev docs
  - üì¶ scope:docs
  - üë§ @contributor-5
```

---

## Workflow templates

### Draft Release (manual)

Creates the release PR (version + changelog + commits).

```yaml
name: Draft Release
on: workflow_dispatch

permissions:
  contents: write
  pull-requests: write

jobs:
  draft-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Draft Release PR (compute version + commit bump + changelog + open PR)
        uses: nalchevanidze/relasy/actions/draft-release@0.1.5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### Publish Release (on merge of release PR)

Publishes GitHub Release from the merged release PR.

```yaml
name: Publish Release
on:
  pull_request:
    types: [closed]

permissions:
  contents: write

jobs:
  publish_release:
    if: ${{ github.base_ref == 'main' && startsWith(github.head_ref, 'release-') && github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.publish.outputs.upload_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Publish GitHub Release (from merged release PR)
        uses: nalchevanidze/relasy/actions/publish-release@0.1.5
        id: publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

## Recommended labeling rules

To keep changelogs predictable, it helps if each PR has:

* **exactly one** ‚Äútype‚Äù label (breaking/feature/fix/etc.)
* optional scope labels for monorepos (`scope:<name>`)

Example labels:

* `type:breaking`
* `type:feature`
* `type:fix`
* `type:chore`
* `scope:client`, `scope:server`, `scope:docs`

Relasy may also include helper actions to:

* bootstrap/standardize labels
* validate that PR labels are allowed (so changelog generation stays clean)


## Helper Actions (recommended)

Relasy works best when PR labels are consistent. To make that easy, add these optional helper actions to your workflows.

### Validate PR labels (`validate-pr-labels`)

This action enforces the ‚Äúlabel contract‚Äù on every PR so releases don‚Äôt get blocked or produce messy changelogs.

What it checks (recommended defaults):
- **Exactly one** change/type label (e.g. `type:breaking`, `type:feature`, `type:fix`, `type:chore`)
- **Zero or one** scope label for monorepos (e.g. `scope:client`, `scope:server`)
- If a scope label is present, it must match a key in `relasy.json` ‚Üí `scope` (prevents typos like `scope:frontend`)

Suggested workflow:

```yaml
name: Validate PR Labels

on:
  pull_request:
    types:
      [
        opened,
        reopened,
        labeled,
        unlabeled,
        synchronize,
        edited,
        ready_for_review,
      ]

permissions:
  contents: read
  pull-requests: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate PR Labels 
        uses: nalchevanidze/relasy/actions/validate-pr-labels@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
````

> Tip: You can also run this in a ‚Äúwarn-only‚Äù mode (comment / log without failing) if you want a softer rollout.

---

### Bootstrap labels (`bootstrap-labels`)

This action creates the labels Relasy expects in a repository (useful for onboarding and keeping label sets consistent).

What it creates (typical):

* Type labels: `type:breaking`, `type:feature`, `type:fix`, `type:chore`
* Scope labels from `relasy.json`: `scope:<scopeKey>` for each key under `scope`

Suggested workflow:

```yaml
name: Bootstrap Labels
on: workflow_dispatch

permissions:
  contents: read
  issues: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create/ensure required labels exist
        uses: nalchevanidze/relasy/actions/bootstrap-labels@0.1.5
```


## Contributing

Issues and PRs are welcome. If you‚Äôre proposing a behavior change, include:

* your label taxonomy (type + scope)
* expected version bump behavior
* expected changelog output structure
